<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PASS Program - COMLEX Practice Questions</title>
<style>
  :root { --pass-navy:#0A1E3A; --pass-gold:#D69E2E; --bg:#edf2f8; --card:#ffffff; --muted:#6b7280; }
  * { box-sizing:border-box; }
  body { margin:0; padding:0; background:var(--bg);
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; color:#111827; }
  .topbar { background:var(--pass-navy); color:#fff; padding:14px 20px; border-bottom:3px solid #07152A;
            display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .brand { font-size:1.05rem; font-weight:700; letter-spacing:.2px; }
  .logo-btn { display:flex; align-items:center; border:none; background:transparent; padding:0; margin:0; position:relative; z-index:2; }
  #pass-logo { height:52px; width:auto; cursor:pointer; outline:none; object-fit:contain; }
  #pass-logo:focus-visible { box-shadow:0 0 0 3px rgba(214,158,46,.45); border-radius:4px; }

  .controls-inline > * { margin-right:8px; }
  .btn { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; color:#fff; background:var(--pass-navy); }
  .btn.secondary { background:#6b7280; }
  .btn.outline { background:#fff; color:#111827; border:1px solid #d1d5db; }
  .btn:hover { filter:brightness(0.95); }
  input[type=number] { width:110px; padding:8px; border:1px solid #d1d5db; border-radius:6px; }
  input[type=file] { color:#fff; }

  .container { max-width:980px; margin:24px auto; background:var(--card); border-radius:10px;
               box-shadow:0 6px 18px rgba(0,0,0,0.08); padding:22px; }
  .qid { color:var(--muted); font-weight:600; margin-bottom:4px; }
  .meta { color:#334155; font-size:.9rem; margin-bottom:6px; }
  .vignette { background:#f7fafc; border-left:5px solid var(--pass-gold); padding:12px; margin-bottom:10px; }
  .findings-title { font-weight:700; margin:10px 0 6px; color:#0f172a; }
  ul.findings { margin:0 0 12px 20px; }

  /* Answer option + inline rationale */
  .option { display:block; padding:12px 14px; margin:10px 0;
            border:1px solid #e5e7eb; border-radius:10px; background:#fafafa; cursor:pointer; transition:border-color .15s, background .15s; }
  .option .row-top{ display:flex; align-items:flex-start; gap:10px; }
  .option input[type=radio] { margin-top:2px; }
  .option .text { flex:1; }
  .option .strike-btn { margin-left:auto; font-size:0.85rem; background:#f3f4f6; border:1px solid #d1d5db;
                        border-radius:6px; padding:4px 8px; cursor:pointer; }
  .option .rationale { display:none; margin-top:10px; padding:10px; border-radius:8px; background:#f9fafb; border:1px solid #e5e7eb; line-height:1.45; }
  .option.show-rationale .rationale{ display:block; }
  .option.opt-correct{ border-color:#059669; background:#ecfdf5; }
  .option.opt-incorrect{ border-color:#b91c1c; background:#fef2f2; }
  .option.opt-neutral{}

  .struck { text-decoration:line-through; color:#6b7280; }

  .reveal-controls{display:none;margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;}
  .btn-outline{background:#fff;color:#111827;border:1px solid #d1d5db;}
  .btn-outline:hover{background:#f3f4f6;}
  .nav { display:flex; gap:10px; margin-top:16px; align-items:center; flex-wrap:wrap; }
  .scorebar{font-size:.9rem;color:#e5e7eb;margin-left:8px;}
  .editor { display:none; margin-top:14px; background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
  .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  textarea, input[type=text], input[type=password] { width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px; font-family:inherit; }
  label.small { font-size:0.85rem; color:#374151; }

  .modal-backdrop { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:999; }
  .modal { position:fixed; top:8%; left:50%; transform:translateX(-50%);
    width:min(760px, 92vw); max-height:80vh; overflow:auto; background:#fff; border-radius:10px;
    box-shadow:0 12px 24px rgba(0,0,0,0.25); padding:16px; z-index:1000; display:none; }
  .modal h3 { margin-top:0; }
  .muted { color:#6b7280; font-size:0.85rem; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .field { flex:1; }
  .small-note { font-size:.8rem; color:#6b7280; }

  .toast { position:fixed; right:14px; bottom:14px; background:#111827; color:#fff;
           padding:10px 12px; border-radius:8px; font-size:.85rem; box-shadow:0 6px 18px rgba(0,0,0,.2); display:none; }
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand-wrap">
      <div class="brand">PASS Program - COMLEX Practice Questions</div>
      <span class="scorebar"></span>
    </div>
    <div class="row" style="gap:12px; align-items:center;">
      <div class="controls-inline" id="student-controls">
        <input type="number" id="goto" min="1" placeholder="Go to #">
        <button class="btn" onclick="goTo()">Go</button>
        <button class="btn outline" onclick="openComment()">Comment</button>
      </div>

      <!-- Logo (auto-finds PASS Logo.png if present) -->
      <button id="logoBtn" class="logo-btn" type="button" aria-label="Open admin login"
              onclick="openAdminLogin();" onkeydown="if(event.key==='Enter'||event.key===' '){openAdminLogin(); event.preventDefault();}">
        <img id="pass-logo" src="PASS%20Logo.png" alt="PASS Program logo" onclick="openAdminLogin();" />
      </button>

      <div class="controls-inline" id="admin-controls" style="display:none;">
        <input type="file" id="fileInput" accept=".json,.js" />
        <button class="btn" onclick="importQuestions()">Import</button>
        <button class="btn secondary" onclick="toggleEditor()">Edit</button>
        <button class="btn secondary" onclick="showLog()">Track Changes</button>
        <button class="btn" onclick="openGHSourceSave()">Save edits to source files</button>
        <button class="btn outline" onclick="saveHTML()">Save (embed)</button>
        <button class="btn outline" onclick="closeAdminTools()">Close Tools</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="qid" id="qid"></div>
    <div class="meta" id="meta"></div>
    <div class="vignette" id="vignette">Choose your <strong>updated_questions.json</strong> (or .js) and click <em>Import</em> (admin only).</div>
    <div class="findings-title">Physical Findings</div>
    <ul class="findings" id="findings"></ul>
    <div id="options"></div>

    <div class="reveal-controls" id="reveal-controls">
      <button class="btn btn-outline" id="btn-show-correct" onclick="revealCorrect()">Show correct answer</button>
      <button class="btn btn-outline" id="btn-show-all" onclick="revealAll()">Show all explanations</button>
      <button class="btn" id="btn-next-after" onclick="nextQ()" style="display:none;">Next</button>
      <button class="btn secondary" id="btn-review" onclick="startReview()" style="display:none;">Review incorrect</button>
    </div>

    <div class="nav">
      <button class="btn" onclick="prevQ()">Previous</button>
      <button class="btn" onclick="nextQ()">Next</button>
      <button class="btn outline" onclick="randomQ()">Random</button>
      <div class="muted" id="counter" style="margin-left:6px;"></div>
    </div>

    <div class="editor" id="editor">
      <h3>Edit This Question</h3>
      <label class="small">Clinical vignette</label>
      <textarea id="ed_vignette" rows="4"></textarea>

      <div class="grid-2">
        <div>
          <label class="small">Findings (one per line)</label>
          <textarea id="ed_findings" rows="8"></textarea>
        </div>
        <div>
          <label class="small">Options A–E (one per line)</label>
          <textarea id="ed_options" rows="8"></textarea>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label class="small">Rationales A–E (one per line)</label>
          <textarea id="ed_rationales" rows="8"></textarea>
        </div>
        <div>
          <label class="small">Correct option index (0=A … 4=E)</label>
          <input type="number" id="ed_correct" min="0" max="4" />
        </div>
      </div>
      <div style="margin-top:8px;">
        <button class="btn" onclick="applyEdits()">Apply Edits</button>
        <button class="btn secondary" onclick="toggleEditor()">Close</button>
      </div>
    </div>
  </div>

  <!-- Backdrop shared by modals -->
  <div class="modal-backdrop" id="backdrop"></div>

  <!-- Admin login modal -->
  <div class="modal" id="admin-modal" role="dialog" aria-modal="true" aria-labelledby="admin-title">
    <h3 id="admin-title">Administrator Tools</h3>
    <div class="muted">Enter password to unlock: <strong>Import / Edit / Track / Save</strong></div>
    <div class="row" style="margin-top:10px;">
      <div class="field">
        <label class="small">Password</label>
        <input type="password" id="admin-pass" placeholder="••••" />
      </div>
      <button class="btn" id="admin-unlock">Unlock</button>
      <button class="btn secondary" id="admin-cancel">Cancel</button>
    </div>
    <div class="small-note" id="admin-msg" style="margin-top:6px; color:#b91c1c;"></div>
  </div>

  <!-- Track changes modal -->
  <div class="modal" id="logModal" role="dialog" aria-modal="true" aria-labelledby="log-title">
    <h3 id="log-title">Change Log</h3>
    <div id="logBody" class="small-note">No changes yet.</div>
    <div style="margin-top:10px; display:flex; gap:8px;">
      <button class="btn" onclick="downloadLog()">Download .json</button>
      <button class="btn secondary" onclick="hideLog()">Close</button>
    </div>
  </div>

  <!-- Save to original source files modal -->
  <div class="modal" id="gh-modal" role="dialog" aria-modal="true" aria-labelledby="gh-title">
    <h3 id="gh-title">Save edits to original JSON files</h3>
    <div class="small-note" id="gh-summary" style="margin-bottom:8px;"></div>
    <div class="grid-2">
      <div class="field">
        <label class="small">GitHub owner</label>
        <input type="text" id="gh-owner" placeholder="org-or-user" />
      </div>
      <div class="field">
        <label class="small">Repo</label>
        <input type="text" id="gh-repo" placeholder="repository" />
      </div>
    </div>
    <div class="field">
      <label class="small">Commit message</label>
      <input type="text" id="gh-message" placeholder="Update questions via PASS editor" />
    </div>
    <div class="field">
      <label class="small">GitHub token (repo scope)</label>
      <input type="password" id="gh-token" placeholder="ghp_..." />
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="btn" onclick="saveDirtyBackToSources()">Save all edits</button>
      <button class="btn secondary" onclick="closeGH()">Cancel</button>
    </div>
    <div id="gh-msg" class="small-note" style="margin-top:6px;"></div>
  </div>

  <!-- Comment modal -->
  <div class="modal" id="comment-modal" role="dialog" aria-modal="true" aria-labelledby="comment-title">
    <h3 id="comment-title">Submit a Comment</h3>
    <div class="muted" style="margin-bottom:8px;">Your feedback goes to <strong>OMMtutor@passprogram.net</strong></div>
    <div class="row">
      <div class="field">
        <label class="small">Your email (optional)</label>
        <input type="text" id="cmt_email" placeholder="you@example.com" />
      </div>
      <div class="field">
        <label class="small">Subject</label>
        <input type="text" id="cmt_subject" placeholder="Issue / Suggestion" />
      </div>
    </div>
    <label class="small" style="margin-top:8px; display:block;">Comment</label>
    <textarea id="cmt_body" rows="6" placeholder="Type your feedback here..."></textarea>
    <div class="small-note" style="margin-top:6px;">
      We include metadata with your comment: Question ID, current selection, time on question, and browser info.
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="btn" onclick="sendComment()">Send Email</button>
      <button class="btn secondary" onclick="copyComment()">Copy to clipboard</button>
      <button class="btn outline" onclick="saveCommentCSV()">Save comments (.csv)</button>
      <button class="btn secondary" onclick="closeComment()">Close</button>
    </div>
    <div id="cmt_msg" class="small-note" style="margin-top:8px; color:#065f46;"></div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Embedded questions (filled only after you Save (embed)) -->
  <script id="embedded-questions" type="application/json"></script>

  <script>
    let idx = 0;
    window.QUESTIONS = [];
    window.CHANGE_LOG = [];
    window.__score = {attempted:0, correct:0};
    window.__missed = [];
    window.__answered = {};
    window.__expOpen = {};
    window.__qStart = Date.now();
    window.__timeSpent = {};
    window.__reviewMode = false;
    window.__reviewQueue = [];
    window.__reviewPtr = 0;
    window.__adminUnlocked = false;

    // Track file shapes so we can write back with the same shape
    // key: fileKey "owner/repo@branch:path"
    window.__fileShapes = {};  // {shape:'array'|'object-questions'}
    const $ = (id) => document.getElementById(id);
    const log = (...a)=>console.log('[QBANK]',...a);

    function toast(msg){
      const t=$('toast'); if(!t) return;
      t.textContent=msg; t.style.display='block';
      setTimeout(()=>{ t.style.display='none'; }, 4200);
    }

    /* ----------------- LOGO AUTODETECT ----------------- */
    async function resolveLogo(){
      const img = $('pass-logo');
      if (!img) return;
      const base = new URL('.', location.href);
      const candidates = [
        'PASS%20Logo.png','PASS Logo.png',
        'assets/PASS%20Logo.png','assets/PASS Logo.png',
        'images/PASS%20Logo.png','images/PASS Logo.png',
        'img/PASS%20Logo.png','img/PASS Logo.png',
        'pass-logo.png','assets/pass-logo.png','images/pass-logo.png','img/pass-logo.png'
      ];
      try { if (img.complete && img.naturalWidth > 0) return; } catch(_) {}
      for (const rel of candidates){
        try{
          const u = new URL(rel, base);
          const r = await fetch(u.href, {cache:'no-cache'});
          const ct = (r.headers.get('content-type')||'').toLowerCase();
          if (r.ok && (ct.includes('image') || /\.(png|jpg|jpeg|gif|svg)$/i.test(u.pathname))){
            img.src = u.href;
            return;
          }
        }catch(_){}
      }
    }

    function escapeHTML(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }
    function normID(v, i){ const n = parseInt(v,10); return isFinite(n) ? ("Q"+String(n).padStart(4,"0")) : ("Q"+String(i+1).padStart(4,"0")); }
    function getOpenSet(qi){ if(!window.__expOpen[qi]) window.__expOpen[qi] = new Set(); return window.__expOpen[qi]; }
    function formatTime(ms){ const s=Math.floor(ms/1000); const m=Math.floor(s/60); const r=s%60; return m+":"+String(r).padStart(2,"0"); }
    function updateTopbar(){
      const brand = document.querySelector('.brand'); if(!brand) return;
      let right = document.querySelector('.scorebar');
      if(!right){ right = document.createElement('span'); right.className='scorebar'; brand.after(right); }
      const att = window.__score.attempted||0; const cor = window.__score.correct||0;
      const pct = att ? Math.round(100*cor/att) : 0;
      const elapsed = (window.__timeSpent[idx]||0) + (Date.now()-window.__qStart);
      right.textContent = `Score ${cor}/${att} (${pct}%) • Time ${formatTime(elapsed)}`;
    }
    function startTimer(){ window.__qStart = Date.now(); updateTopbar(); }
    function stopTimer(){ const now=Date.now(); const spent = now - window.__qStart; window.__timeSpent[idx]=(window.__timeSpent[idx]||0)+spent; updateTopbar(); }

    function showModal(id, show=true){ const m=$(id); const bd=$('backdrop'); if(!m||!bd) return; bd.style.display = show?'block':'none'; m.style.display = show?'block':'none'; }
    function openAdminLogin(){ try{ $('admin-pass').value=''; $('admin-msg').textContent=''; showModal('admin-modal', true); }catch(e){ alert('Admin dialog error: '+e.message); } }
    function closeAdminLogin(){ showModal('admin-modal', false); }

    function adminUnlock(){ const pwd = $('admin-pass').value.trim();
      if (pwd === '1996'){ window.__adminUnlocked = true; closeAdminLogin(); $('admin-controls').style.display='block'; }
      else { $('admin-msg').textContent='Incorrect password.'; }
    }
    function closeAdminTools(){ $('admin-controls').style.display='none'; }

    function bindLogoTriggers(){ 
      const btn = $('logoBtn'); const img = $('pass-logo'); const topbar = document.querySelector('.topbar');
      if(btn) btn.addEventListener('click', openAdminLogin);
      if(img) img.addEventListener('click', openAdminLogin);
      document.addEventListener('click', (e)=>{ if(e.target.closest('#logoBtn') || e.target.closest('#pass-logo')) openAdminLogin(); });
      document.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.altKey && (e.key==='a'||e.key==='A')) openAdminLogin(); });
      if(topbar) topbar.addEventListener('dblclick', (e)=>{ if(e.shiftKey) openAdminLogin(); });
      let lpTimer=null; const start=()=>{ lpTimer=setTimeout(openAdminLogin, 650); }; const clear=()=>{ if(lpTimer){clearTimeout(lpTimer); lpTimer=null;} };
      for (const el of [btn,img]) if(el){ el.addEventListener('mousedown', start); el.addEventListener('touchstart', start);
        el.addEventListener('mouseup', clear); el.addEventListener('mouseleave', clear); el.addEventListener('touchend', clear); }
    }

    /* ---------- normalization & parsing ---------- */
    function pickFields(obj, keys){ for(const k of keys){ if(obj && obj[k]!=null) return obj[k]; } return undefined; }

    function collectFindings(q){
      if (Array.isArray(q.findings)) return q.findings.map(x=>String(x).trim()).filter(Boolean);
      const keys = ['Finding 1','Finding 2','Finding 3','Finding 4','Finding 5','Finding 6','finding1','finding2','finding3','finding4','finding5','finding6'];
      const out=[]; for(const k of keys){ if(q[k]) out.push(String(q[k]).trim()); } return out.filter(Boolean);
    }

    function extractOptionsAndRationales(q){
      if (Array.isArray(q.options) && q.options.length){
        if (typeof q.options[0] === 'object'){
          const opts = q.options.map(o => String(o.text ?? o.option ?? o.label ?? '').trim());
          const rats = q.options.map(o => String(o.rationale ?? o.explanation ?? '').trim());
          return {options: opts.slice(0,5), rationales: rats.slice(0,5)};
        } else {
          const opts = q.options.map(s=>String(s||'').trim()).slice(0,5);
          let rats = [];
          if (Array.isArray(q.rationales)) rats = q.rationales.map(r => (typeof r==='object' && r.rationale) ? String(r.rationale) : String(r||'')).slice(0,5);
          return {options: opts, rationales: rats};
        }
      }
      const letters=['A','B','C','D','E'];
      const opts = letters.map(L => q[L]).filter(Boolean).map(x=>String(x).trim());
      const rats = letters.map(L => q['R'+L] ?? q['r'+L]).filter(Boolean).map(x=>String(x).trim());
      return {options: opts, rationales: rats};
    }

    function normalizeQuestion(q, i, meta){
      const {options, rationales} = extractOptionsAndRationales(q);
      let correctIndex = (typeof q.correctIndex === "number") ? q.correctIndex : -1;
      if(correctIndex<0){
        const corr = pickFields(q,['Correct','correct','answer','correctLetter']);
        if(typeof corr==='number') correctIndex=corr;
        else if(typeof corr==='string'){ const map={A:0,B:1,C:2,D:3,E:4}; const up=corr.trim().toUpperCase(); if(map.hasOwnProperty(up)) correctIndex=map[up]; }
      }
      if(correctIndex<0){
        const diag=String(q.diagnosis??q.answerText??'').trim().toLowerCase();
        for (let k=0;k<options.length;k++){ if ((options[k]||'').trim().toLowerCase()===diag){ correctIndex=k; break; } }
      }
      const findings = collectFindings(q);
      const vignette = String(q.vignette??q.stem??'').trim();
      const id = normID(pickFields(q,['id','ID','qid','Question ID']), i);
      const norm = { id, category: String(q.category??'').trim(), diagnosis:String(q.diagnosis??'').trim(), vignette, findings, options, rationales, correctIndex };
      if (meta){ norm.__src = meta; norm.__srcIndex = i; }
      return norm;
    }
    function normalizeArray(arr, meta){ return arr.map((q,i)=>normalizeQuestion(q,i,meta)); }

    function parseJsonOrJsArray(text){
      try{
        const data=JSON.parse(text);
        if (Array.isArray(data)) return {arr:data, shape:'array'};
        if (data && Array.isArray(data.questions)) return {arr:data.questions, shape:'object-questions'};
      }catch(_){}
      const m=text.match(/(?:window\.QUESTIONS\s*=\s*|const\s+\w+\s*=\s*)(\[[\s\S]*\]);?/);
      if (m){ try { const arr=JSON.parse(m[1]); return {arr, shape:'array'}; } catch(_){} }
      return null;
    }

    /* ---------- import / autoload ---------- */
    function importQuestions(){ if (!window.__adminUnlocked){ alert('Admin tools are locked. Click the PASS logo and enter the password.'); return; }
      const file = $('fileInput').files[0]; if(!file){ alert('Choose your updated_questions.json (or .js) first.'); return; }
      const reader = new FileReader();
      reader.onload = (e)=>{ const text=e.target.result; const parsed = parseJsonOrJsArray(text);
        if (parsed){ const meta = deriveLocalMeta(file.name); window.QUESTIONS = normalizeArray(parsed.arr, meta); trackFileShape(meta, parsed.shape); resetState(); render(); }
        else alert('Could not parse file. Provide a JSON array or a JS file that assigns an array.');
      };
      reader.readAsText(file);
    }

    function deriveLocalMeta(pathGuess){
      // Use page’s repo for writes; pick a probable branch
      const info = detectRepoFromPageURL();
      const branch = window.__pagesBranch || 'gh-pages';
      return info ? {type:'github', owner:info.owner, repo:info.repo, branch, path:pathGuess} : {type:'unknown'};
    }

    async function tryFetchList(entries){
      const all = [];
      for (const ent of entries){
        const item = (typeof ent === 'string') ? {href: ent} : ent;
        try{
          const txt = await fetch(item.href, {cache:'no-cache'}).then(r=> r.ok ? r.text() : Promise.reject(new Error(r.status)));
          const parsed = parseJsonOrJsArray(txt);
          if (!parsed) continue;
          if (item.meta && item.meta.fileKey && parsed.shape) trackFileShape(item.meta, parsed.shape);
          const meta = item.meta || null;
          all.push({arr:parsed.arr, meta});
        }catch(_){}
      }
      for (const chunk of all){
        mergeQuestions(normalizeArray(chunk.arr, chunk.meta));
      }
      if (all.length){ toast(`Loaded ${all.reduce((n,c)=>n+c.arr.length,0)} items from ${all.length} file(s).`); }
    }

    function detectRepoFromPageURL(){
      const host = location.host; // e.g., passcomlex.github.io
      const owner = host.split('.')[0];
      const pathParts = location.pathname.replace(/^\/+/,'').split('/');
      const repo = pathParts[0] || '';
      return owner && repo ? {owner, repo} : null;
    }

    async function safeJson(url, headers={}){
      try{ const r = await fetch(url, {headers, cache:'no-cache'}); if (!r.ok) return null; return await r.json(); }
      catch(_){ return null; }
    }

    function fileKeyFromMeta(meta){
      if (!meta || meta.type!=='github') return null;
      return `${meta.owner}/${meta.repo}@${meta.branch}:${meta.path}`;
    }
    function trackFileShape(meta, shape){
      const key = fileKeyFromMeta(meta); if (!key || !shape) return;
      window.__fileShapes[key] = {shape};
    }

    async function githubAPIScanAndLoad(){
      const info = detectRepoFromPageURL(); if (!info) return;
      const {owner, repo} = info;
      const apiBase = `https://api.github.com/repos/${owner}/${repo}`;
      const meta = await safeJson(`${apiBase}`);
      const defaultBranch = meta?.default_branch || 'main';
      let pages = await safeJson(`${apiBase}/pages`);
      window.__pagesBranch = pages?.source?.branch || null;

      let branches = [ 'gh-pages', window.__pagesBranch, defaultBranch, 'main', 'master' ].filter(Boolean);
      try{
        const list = await safeJson(`${apiBase}/branches?per_page=100`);
        const names = Array.isArray(list) ? list.map(b=>b.name) : [];
        for (const n of names){ if(!branches.includes(n)) branches.push(n); }
      }catch(_){}

      const dirs = ['', 'questions', 'data', 'json', 'assets', 'qbank'];

      for (const br of branches){
        for (const dir of dirs){
          const url = `${apiBase}/contents/${dir}?ref=${encodeURIComponent(br)}`;
          const arr = await safeJson(url);
          if (!Array.isArray(arr)) continue;
          const jsonLike = arr.filter(it => it && it.type==='file' && /\.(json|js)$/i.test(it.name) && !/index\.html?$/i.test(it.name));
          const entries = jsonLike.map(it => ({
              href: it.download_url,
              meta: {type:'github', owner, repo, branch: br, path: it.path, fileKey: `${owner}/${repo}@${br}:${it.path}`}
          }));
          await tryFetchList(entries);
        }
      }
    }

    function mergeQuestions(newQs){
      const clean = newQs.filter(q => Array.isArray(q.options) && q.options.length>0);
      const map = new Map(window.QUESTIONS.map(q => [q.id, q]));
      for (const q of clean){ if (!map.has(q.id)){ map.set(q.id, q); window.QUESTIONS.push(q); } }
    }

    async function autoLoadAll(){
      try{
        const emb = $('embedded-questions');
        if(emb && emb.textContent.trim()){
          const data = JSON.parse(emb.textContent);
          if(Array.isArray(data)) window.QUESTIONS = normalizeArray(data, null);
        }
      }catch(_){}
      // Load from GitHub API first (best metadata for saving)
      await githubAPIScanAndLoad();

      // Also try common relative files in the site (assign guessed meta)
      const info = detectRepoFromPageURL();
      const branchGuess = window.__pagesBranch || 'gh-pages';
      const relFiles = [
        'questions.json','updated_questions.json','questions.js',
        'data/questions.json','data/updated_questions.json',
        'questions/questions.json','json/questions.json','assets/questions.json'
      ];
      const relEntries = relFiles.map(p=>{
        const u = new URL(p, location.href).href;
        const meta = info ? {type:'github', owner:info.owner, repo:info.repo, branch:branchGuess, path:p, fileKey:`${info.owner}/${info.repo}@${branchGuess}:${p}`} : null;
        return {href:u, meta};
      });
      await tryFetchList(relEntries);
    }

    /* ---------- rendering with inline rationales ---------- */
    function resetState(){ idx=0; window.__score={attempted:0,correct:0}; window.__missed=[]; window.__answered={}; window.__expOpen={}; window.__qStart=Date.now(); window.__timeSpent={}; window.__reviewMode=false; window.__reviewQueue=[]; window.__reviewPtr=0; }

    function optionHTML(q, i, selectedIndex){
      const letters=['A','B','C','D','E'];
      const opt=escapeHTML((q.options||[])[i]||'');
      const rat=escapeHTML((q.rationales||[])[i]||'');
      return `
        <div class="option" id="opt-${i}" data-idx="${i}" onclick="onOptionClick(${i})">
          <div class="row-top">
            <input type="radio" name="ans" ${selectedIndex===i?'checked':''} ${selectedIndex>=0?'disabled':''}>
            <div class="text"><strong>${letters[i]})</strong> ${opt}</div>
            <button class="strike-btn" onclick="strike(${i}); event.stopPropagation();">Strike</button>
          </div>
          <div class="rationale" id="rat-${i}">${rat || '—'}</div>
        </div>`;
    }

    function render(){
      const q = window.QUESTIONS[idx];
      if(!q){
        $('qid').textContent=''; $('meta').textContent='';
        $('vignette').textContent='Choose your updated_questions.json (or .js) and click Import (admin only).';
        $('findings').innerHTML=''; $('options').innerHTML='';
        $('reveal-controls').style.display='none'; updateTopbar(); return;
      }
      $('qid').textContent = q.id || ('Q'+(idx+1));
      $('meta').textContent = 'Question ' + (idx+1) + ' of ' + window.QUESTIONS.length;
      $('vignette').textContent = q.vignette || '';
      $('findings').innerHTML = (q.findings||[]).map(f=>"<li>"+escapeHTML(f)+"</li>").join('');
      const selectedIndex = (window.__answered.hasOwnProperty(idx)? window.__answered[idx] : -1);
      $('options').innerHTML = (q.options||[]).map((_,i)=> optionHTML(q,i,selectedIndex)).join('');

      const openSet = getOpenSet(idx);
      (q.options||[]).forEach((_,i)=>{
        const box=$('opt-'+i); if(!box) return;
        // rationale visibility
        box.classList.toggle('show-rationale', openSet.has(i));
        // correctness coloring if answered
        box.classList.remove('opt-correct','opt-incorrect','opt-neutral');
        if (window.__answered.hasOwnProperty(idx)){
          const ci=q.correctIndex; const sel=window.__answered[idx];
          if (i===ci) box.classList.add('opt-correct');
          else if (i===sel) box.classList.add('opt-incorrect');
          else box.classList.add('opt-neutral');
        } else box.classList.add('opt-neutral');
      });

      const ctrl = $('reveal-controls'); ctrl.style.display = window.__answered.hasOwnProperty(idx)? 'flex':'none';
      $('btn-next-after').style.display='none'; $('btn-review').style.display = (window.__missed.length ? 'inline-block':'none');
      $('counter').textContent = q.id;
      startTimer(); updateTopbar();
    }

    function onOptionClick(i){
      const q=window.QUESTIONS[idx]; const already=window.__answered.hasOwnProperty(idx);
      if(!already){
        window.__answered[idx]=i; window.__score.attempted += 1;
        if(i===q.correctIndex) window.__score.correct += 1; else if(!window.__missed.includes(idx)) window.__missed.push(idx);
        stopTimer(); const openSet=getOpenSet(idx); openSet.add(i); $('reveal-controls').style.display='flex'; render(); return;
      }
      const openSet=getOpenSet(idx); if(openSet.has(i)) openSet.delete(i); else openSet.add(i); render();
    }
    function revealCorrect(){ const q=window.QUESTIONS[idx]; const ci=q.correctIndex; if(typeof ci!=='number'||ci<0) return; const openSet=getOpenSet(idx); openSet.add(ci); render(); $('btn-next-after').style.display='inline-block'; if(window.__missed.length) $('btn-review').style.display='inline-block'; }
    function revealAll(){ const q=window.QUESTIONS[idx]; const openSet=getOpenSet(idx); (q.options||[]).forEach((_,i)=> openSet.add(i)); render(); $('btn-next-after').style.display='inline-block'; if(window.__missed.length) $('btn-review').style.display='inline-block'; }

    function startReview(){ if(!window.__missed.length){ alert('No incorrect answers to review.'); return; } window.__reviewQueue = Array.from(new Set(window.__missed)); window.__reviewMode = true; window.__reviewPtr=0; idx=window.__reviewQueue[0]; render(); }
    function nextQ(){ stopTimer(); if(window.__reviewMode){ if(window.__reviewPtr < window.__reviewQueue.length-1){ window.__reviewPtr += 1; idx = window.__reviewQueue[window.__reviewPtr]; render(); return; } else window.__reviewMode=false; } if(idx < window.QUESTIONS.length-1){ idx += 1; render(); } }
    function prevQ(){ stopTimer(); if(window.__reviewMode){ if(window.__reviewPtr>0){ window.__reviewPtr -= 1; idx = window.__reviewQueue[window.__reviewPtr]; render(); return; } else window.__reviewMode=false; } if(idx>0){ idx -= 1; render(); } }
    function goTo(){ const n = parseInt($('goto').value,10); if(!isNaN(n)&&n>=1&&n<=window.QUESTIONS.length){ stopTimer(); idx=n-1; render(); } }
    function strike(i){ const optDivs=$('options').querySelectorAll('.option'); const target=optDivs[i]?.querySelector('.text'); if(target) target.classList.toggle('struck'); }

    /* Random */
    function randomQ(){
      stopTimer();
      const pool = window.__reviewMode ? window.__reviewQueue : window.QUESTIONS.map((_,i)=>i);
      if (!pool.length) return;
      const current = window.__reviewMode ? window.__reviewQueue[window.__reviewPtr] : idx;
      let next = current;
      if (pool.length === 1) next = pool[0];
      else { while (next === current) next = pool[Math.floor(Math.random()*pool.length)]; }
      if (window.__reviewMode){ window.__reviewPtr = pool.indexOf(next); }
      idx = next;
      render();
    }

    /* ---------- Editor + mark dirty ---------- */
    function fillEditor(){ const q=window.QUESTIONS[idx]||{vignette:'',findings:[],options:[],rationales:[],correctIndex:-1};
      $('ed_vignette').value=q.vignette||''; $('ed_findings').value=(q.findings||[]).join('\n');
      $('ed_options').value=(q.options||[]).join('\n'); $('ed_rationales').value=(q.rationales||[]).join('\n');
      $('ed_correct').value=(typeof q.correctIndex==='number'? q.correctIndex : -1);
    }
    function toggleEditor(){ if(!window.__adminUnlocked){ alert('Admin tools are locked. Click the PASS logo and enter the password.'); return; } const ed=$('editor'); ed.style.display=(ed.style.display==='block'?'none':'block'); if(ed.style.display==='block') fillEditor(); }

    function applyEdits(){ if(!window.__adminUnlocked){ alert('Admin tools are locked.'); return; }
      const q=window.QUESTIONS[idx]; if(!q) return; const before=JSON.parse(JSON.stringify(q));
      q.vignette=$('ed_vignette').value.trim(); q.findings=$('ed_findings').value.split(/\n/).map(s=>s.trim()).filter(Boolean);
      q.options=$('ed_options').value.split(/\n/).map(s=>s.trim()).filter(Boolean).slice(0,5);
      q.rationales=$('ed_rationales').value.split(/\n/).map(s=>s.trim()).filter(Boolean).slice(0,5);
      const ci=parseInt($('ed_correct').value,10); q.correctIndex=isNaN(ci)? -1 : ci;
      q.__dirty = true;
      window.CHANGE_LOG.push({time:new Date().toISOString(), id:q.id, before, after: JSON.parse(JSON.stringify(q))});
      render();
      toast('Edits applied locally. Use “Save edits to source files” to commit them.');
    }

    function cleanForSave(q){
      return {
        id:q.id, category:q.category||'', diagnosis:q.diagnosis||'',
        vignette:q.vignette||'', findings:Array.isArray(q.findings)?q.findings:[],
        options:Array.isArray(q.options)?q.options:[],
        rationales:Array.isArray(q.rationales)?q.rationales:[],
        correctIndex: (typeof q.correctIndex==='number'? q.correctIndex : -1)
      };
    }

    /* ---------- Save edits back to their original source JSON files ---------- */

    function openGHSourceSave(){
      if(!window.__adminUnlocked){ alert('Admin tools are locked.'); return; }
      const info = detectRepoFromPageURL() || {owner:'', repo:''};
      $('gh-owner').value = info.owner || '';
      $('gh-repo').value = info.repo || '';
      $('gh-message').value = 'Update questions via PASS editor';
      $('gh-token').value = '';
      $('gh-msg').textContent = '';

      const dirty = window.QUESTIONS.filter(q=>q.__dirty && q.__src && q.__src.type==='github' && /\.json$/i.test(q.__src.path));
      const byFile = groupBy(dirty, q => fileKeyFromMeta(q.__src)||'unknown');
      const lines = [];
      for (const [key, arr] of Object.entries(byFile)){
        if (key==='unknown') continue;
        const meta = keyToMeta(key);
        lines.push(`• ${meta.path} @ ${meta.branch} — ${arr.length} change(s)`);
      }
      $('gh-summary').textContent = lines.length ? ('Files to update:\n' + lines.join('\n')) : 'No JSON-file edits pending.';
      showModal('gh-modal', true);
    }

    function closeGH(){ showModal('gh-modal', false); }

    function groupBy(list, fn){
      const m = new Map();
      for (const x of list){ const k = fn(x); if(!m.has(k)) m.set(k, []); m.get(k).push(x); }
      return Object.fromEntries(m.entries());
    }

    function keyToMeta(key){
      // owner/repo@branch:path
      const [left, path] = key.split(':');
      const [proj, branch] = left.split('@');
      const [owner, repo] = proj.split('/');
      return {type:'github', owner, repo, branch, path, fileKey:key};
    }

    async function saveDirtyBackToSources(){
      const owner = $('gh-owner').value.trim();
      const repo = $('gh-repo').value.trim();
      const token = $('gh-token').value.trim();
      const message = $('gh-message').value.trim() || 'Update questions via PASS editor';
      const headers = {'Accept':'application/vnd.github+json','Authorization':'Bearer '+token};

      if (!owner || !repo || !token){ $('gh-msg').style.color='#b91c1c'; $('gh-msg').textContent='Owner, repo, and token are required.'; return; }

      const dirty = window.QUESTIONS.filter(q=>q.__dirty && q.__src && q.__src.type==='github');
      const groups = groupBy(dirty, q => fileKeyFromMeta(q.__src)||'unknown');
      const keys = Object.keys(groups).filter(k=>k!=='unknown');

      if (!keys.length){ $('gh-msg').style.color='#065f46'; $('gh-msg').textContent='Nothing to save.'; return; }

      $('gh-msg').style.color='#6b7280'; $('gh-msg').textContent='Saving...';

      let ok=0, fail=0, skipped=0, notes=[];

      for (const key of keys){
        const meta = keyToMeta(key);
        if (!/\.json$/i.test(meta.path)){ skipped++; notes.push(`Skipped non-JSON: ${meta.path}`); continue; }

        // if page’s owner/repo differ from source, prefer source metadata
        const effOwner = meta.owner || owner;
        const effRepo  = meta.repo  || repo;

        try{
          // Get current file to read sha + content
          const getUrl = `https://api.github.com/repos/${effOwner}/${effRepo}/contents/${encodeURIComponent(meta.path)}?ref=${encodeURIComponent(meta.branch)}`;
          const r1 = await fetch(getUrl, {headers});
          if (!r1.ok){ throw new Error(`GET ${meta.path} failed: ${r1.status}`); }
          const info = await r1.json();
          const text = atob(info.content.replace(/\n/g,''));
          const parsed = parseJsonOrJsArray(text);
          if (!parsed || !Array.isArray(parsed.arr)){ throw new Error('File is not JSON array nor {questions:[...]}.'); }

          // Build new array by replacing items whose id matches dirty ones
          const dirtyInThis = groups[key];
          const dirtyById = new Map(dirtyInThis.map(q=>[q.id, cleanForSave(q)]));
          let baseArr = parsed.arr.map(obj=>{
            const id = String(obj.id ?? obj.qid ?? '').trim() || null;
            return id && dirtyById.has(id) ? dirtyById.get(id) : obj;
          });

          // Also append any edited items whose id was not found in file (rare)
          for (const q of dirtyInThis){
            if (!baseArr.some(x=>String(x.id||'')===q.id)){
              baseArr.push(cleanForSave(q));
            }
          }

          // Keep original shape
          let outObj = (parsed.shape==='object-questions') ? {questions: baseArr} : baseArr;
          const body = {
            message,
            branch: meta.branch,
            content: btoa(unescape(encodeURIComponent(JSON.stringify(outObj, null, 2)))),
            sha: info.sha
          };
          const putUrl = `https://api.github.com/repos/${effOwner}/${effRepo}/contents/${encodeURIComponent(meta.path)}`;
          const r2 = await fetch(putUrl, {method:'PUT', headers, body:JSON.stringify(body)});
          if (!r2.ok){ const t=await r2.text(); throw new Error(t||('PUT failed '+r2.status)); }

          // Clear dirty flags for those questions
          for (const q of dirtyInThis){ q.__dirty = false; }
          ok++;
        }catch(e){
          fail++; notes.push(`${meta.path}: ${e.message}`);
        }
      }

      const msg = `Saved: ${ok}, Failed: ${fail}, Skipped: ${skipped}` + (notes.length?`\n• ${notes.join('\n• ')}`:'');
      $('gh-msg').style.whiteSpace='pre-wrap';
      $('gh-msg').style.color = fail ? '#b91c1c' : '#065f46';
      $('gh-msg').textContent = msg;
      toast(msg);
    }

    /* ---------- Comments ---------- */
    function openComment(){ $('cmt_email').value=''; $('cmt_subject').value=''; $('cmt_body').value=''; showModal('comment-modal', true); }
    function closeComment(){ showModal('comment-modal', false); }
    function collectMeta(){ const q=window.QUESTIONS[idx]||{}; return { id:q.id||'', selection: window.__answered[idx], time: (window.__timeSpent[idx]||0), ua:navigator.userAgent }; }
    function copyComment(){ const meta=collectMeta(); const msg=`[Question ${meta.id}]
Selection: ${meta.selection}
Time(ms): ${meta.time}
UA: ${meta.ua}

` + $('cmt_body').value;
      navigator.clipboard.writeText(msg).then(()=>{ /* ok */ });
    }
    function saveCommentCSV(){ const meta=collectMeta(); const rows=[['id','selection','time_ms','ua','email','subject','comment'],[meta.id,meta.selection,meta.time,meta.ua, $('cmt_email').value, $('cmt_subject').value, $('cmt_body').value.replace(/\n/g,' ')]];
      const csv=rows.map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='PASS_Comments.csv'; a.click(); }
    function sendComment(){ const meta=collectMeta(); const subject=encodeURIComponent('PASS OMM feedback: '+($('cmt_subject').value||meta.id)); 
      const body=encodeURIComponent(`[Question ${meta.id}]
Selection: ${meta.selection}
Time(ms): ${meta.time}
UA: ${meta.ua}

` + $('cmt_body').value);
      window.location.href = `mailto:OMMtutor@passprogram.net?subject=${subject}&body=${body}`; }

    /* ---------- Keys ---------- */
    document.addEventListener('keydown', function(e){
      if (e.key==='ArrowRight'){ e.preventDefault(); nextQ(); }
      else if (e.key==='ArrowLeft'){ e.preventDefault(); prevQ(); }
      else if (e.key.toLowerCase()==='r'){ e.preventDefault(); randomQ(); }
    });

    /* ---------- Init ---------- */
    window.addEventListener('DOMContentLoaded', async ()=>{
      bindLogoTriggers();
      resolveLogo();

      $('admin-unlock').addEventListener('click', adminUnlock);
      $('admin-cancel').addEventListener('click', closeAdminLogin);
      $('backdrop').addEventListener('click', ()=>{ closeAdminLogin(); hideLog(); closeComment(); closeGH(); });

      await autoLoadAll();

      if(window.QUESTIONS.length){ render(); }
      else { updateTopbar(); }
    });

    /* ---------- Change log / embed ---------- */
    function showLog(){ if(!window.__adminUnlocked){ alert('Admin tools are locked.'); return; }
      const body=$('logBody'); if(!(window.CHANGE_LOG||[]).length) body.innerHTML='<div class="muted">No changes yet.</div>';
      else body.innerHTML=(window.CHANGE_LOG||[]).map(ch=>`
        <div class="chg" style="margin-bottom:8px;">
          <div><strong>${ch.id}</strong> <span class="muted">at ${ch.time}</span></div>
          <div class="muted">Vignette (old → new)</div>
          <div>${escapeHTML(ch.before.vignette||"")} <span class="muted">→</span> ${escapeHTML(ch.after.vignette||"")}</div>
          <div class="muted">Findings (old → new)</div>
          <div>${escapeHTML((ch.before.findings||[]).join(' | '))} <span class="muted">→</span> ${escapeHTML((ch.after.findings||[]).join(' | '))}</div>
          <div class="muted">Options (old → new)</div>
          <div>${escapeHTML((ch.before.options||[]).join(' | '))} <span class="muted">→</span> ${escapeHTML((ch.after.options||[]).join(' | '))}</div>
          <div class="muted">Rationales (old → new)</div>
          <div>${escapeHTML((ch.before.rationales||[]).join(' | '))} <span class="muted">→</span> ${escapeHTML((ch.after.rationales||[]).join(' | '))}</div>
          <div class="muted">CorrectIndex (old → new)</div>
          <div>${String(ch.before.correctIndex ?? "")} → ${String(ch.after.correctIndex ?? "")}</div>
        </div>`).join("");
      showModal('logModal', true);
    }
    function hideLog(){ showModal('logModal', false); }

    function saveHTML(){ if (!window.__adminUnlocked){ alert('Admin tools are locked.'); return; }
      const data = JSON.stringify(window.QUESTIONS.map(cleanForSave), null, 2);
      const doc = document.documentElement.cloneNode(true);
      const emb = doc.querySelector('#embedded-questions');
      if (emb) emb.textContent = data; else { const s = doc.createElement('script'); s.id='embedded-questions'; s.type='application/json'; s.textContent=data; doc.body.appendChild(s); }
      const html = '<!DOCTYPE html>\n' + doc.outerHTML;
      const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([html], {type:'text/html'}));
      const ts = new Date().toISOString().replace(/[:.]/g,'-'); a.download = 'PASS_COMLEX_OMM_QBank_'+ts+'.html'; a.click();
    }
  </script>
</body>
</html>
